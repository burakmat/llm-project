<!-- myapp/templates/home.html -->
<html>
<head>
    
    <title>BookBot</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
</head>
<style>
.card {
  width: 292px;
  border-radius: 8px;
  background-color: white;
  padding-right: 0.5em;
  padding-left: 0.5em;
  border: 1px solid black;
  transition: .2s ease-in-out;
}
.card:hover {
    filter: drop-shadow(2px 4px 6px #DDDDDD);
    transition: .2s ease-in-out;
}
a{
    text-decoration: none;
    color: black;
}
.breathing-dot {
    width: 15px; 
    height: 15px; 
    background-color: #708b85; 
    border-radius: 50%; /* Make it circular */
    animation: breathing 2s ease-in-out infinite;
}

@keyframes breathing {
    0%, 100% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.5);
        opacity: 0.7;
    }
}
.file-input__input {
  width: 40px;
  height: 40px;
  opacity: 0;
  overflow: hidden;
  position: absolute;
  z-index: -1;
}

.file-input__label {
  cursor: pointer;
  display: inline-flex;
  align-items: center;
    width: 40px;
  height: 40px;

}

.file-input__label svg {
  height: 40px;
 }


</style>
<body style="font-family: 'Lato', sans-serif; background: #fdfdfc; padding-top: 2em;">
<nav>
    <h1 style="text-align: center">BookBot</h1>
</nav>

<main style="margin: 0 auto; width: 1000px; ">
    <div style="display: flex; gap: 1em; align-items: center;">
        <form method="post" enctype="multipart/form-data" action="{% url 'upload_file' %}">
            {% csrf_token %}

                <input
                type="file"
                name="file-input"
                id="file-input"
                class="file-input__input"
                accept=".pdf"
                onchange="this.form.submit()"
            />
                <label         
                title="Add your own books to the database"  
                class="file-input__label" for="file-input">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-patch-plus-fill" viewBox="0 0 16 16">
                <path d="M10.067.87a2.89 2.89 0 0 0-4.134 0l-.622.638-.89-.011a2.89 2.89 0 0 0-2.924 2.924l.01.89-.636.622a2.89 2.89 0 0 0 0 4.134l.637.622-.011.89a2.89 2.89 0 0 0 2.924 2.924l.89-.01.622.636a2.89 2.89 0 0 0 4.134 0l.622-.637.89.011a2.89 2.89 0 0 0 2.924-2.924l-.01-.89.636-.622a2.89 2.89 0 0 0 0-4.134l-.637-.622.011-.89a2.89 2.89 0 0 0-2.924-2.924l-.89.01zM8.5 6v1.5H10a.5.5 0 0 1 0 1H8.5V10a.5.5 0 0 1-1 0V8.5H6a.5.5 0 0 1 0-1h1.5V6a.5.5 0 0 1 1 0"/>
                </svg>
                </label>
        </form>

        <form id="chat-form" style="display: flex; align-items: center; justify-content: center; gap:1em; ">
            <input autocomplete="off" id="user-input" placeholder="What do you wanna read next?" 
                style="width:900px; font-family: 'Lato', sans-serif; resize: none; border-radius: 8px; padding:1em;"></input>
                <button 
                style="height: 100%; padding: 0.8em 1.5em; cursor: pointer; background: #698c85; border-radius: 8px; font-size:16px;" 
                type="submit">Send</button>
        </form>     

    </div>
    {% if uploaded_file_url %}
        <p>Book added: {{ uploaded_file_url }}</p>
    {% endif %}
    <div id="chat-output"></div>
    <div id="loading" style="text-align: center; display: none;">
        <div class="breathing-dot"></div>
    </div>


    <div id="bookHits" style="display: flex; gap: 2em;">
        
    </div>
</main>
    <script>
        $('#chat-form').on('submit', function(e){
            e.preventDefault();
            var userInput = $('#user-input').val();

            // Clear previous book hits and show loading
            $('#chat-output').empty();
            $('#bookHits').empty();
            $('#loading').show();

            // Append the user's message
            $('#chat-output').append('<p> <span style="font-weight: bold;">You:</span> ' + userInput + '</p>');

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/chat_with_openai/', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}');
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    $('#loading').hide();
                    if(xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);

                        // Display new book hits
                        response.book_hits.forEach(function(hit) {
                            $('#bookHits').append(
                                '<a target="_blank" href="http://www.google.com/search?q=' + hit.payload.name + " " + hit.payload.author + " book"+ '">' +
                                    '<div class="card">' +
                                        '<h4 style="margin-bottom: 4px;">' + hit.payload.name + '</h4>' +
                                        '<small style="color:#535353;">' + hit.payload.author + '</small>' +
                                        '<p>' + hit.payload.description + '</p>' +
                                    '</div>' +
                                '</a>'
                            );
                        });
                    }
                }
            };

            xhr.send('message=' + encodeURIComponent(userInput));

            // Clear the input field after sending the message
            $('#user-input').val('');
        });
    </script>
</body>
</html>
